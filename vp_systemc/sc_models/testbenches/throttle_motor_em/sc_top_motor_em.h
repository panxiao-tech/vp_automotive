/**
 * This file is automatically generated from [XML2SCA] 
 * https://github.com/panxiao-tech/XML2SCA
 * Contact: Xiao Pan <pan@cs.uni-kl.de | xml2sca@panxiao.tech>
 * 
 * @file    ect_sc/tb/throttle_motor/sc_top.h
 * @author  Xiao Pan (pan@cs.uni-kl.de)
 * @date    00:30:34 Jun  2 2018
 * @section LICENSE License (ADD YOUR LICENSE HERE)
 *  
 * @section DESCRIPTION Description (ADD YOUR DESCRIPTION HERE)
 *          DC Motor for Throttle Control
 * 
 */


#ifndef sc_top_motor_h_
#define sc_top_motor_h_
#include "../../src/sca_dcmotor_em.h"
#include "../../src/config_sim.h"
#include "sc_top_eln_e.h"
#include "sc_top_lsf_m.h"



//! ---------------------------------------------------------------------------
//! @brief stimuli module
//! ---------------------------------------------------------------------------
SCA_TDF_MODULE(sca_tdf_stimuli_motor)
{
    //! in/output ports
    sca_tdf::sca_out<double> pout_v; //! DC motor control voltage
    sca_tdf::sca_in<double>  pin_a;  //! throttle position (angle in rad)
    sca_tdf::sca_in<double>  pin_i;  //! instant current of the DC circuiy in ampere
    
    // constructor
    sca_tdf_stimuli_motor(sc_core::sc_module_name nm){}
    
    void set_attributes()
    {
        pin_a.set_delay(1);
        pin_i.set_delay(1);
        pout_v.set_timestep(sc_core::sc_time(gc_t_step, sc_core::SC_SEC ));
    }
    
    void processing()
    {
        double t_now = sc_core::sc_time_stamp().to_seconds();
        double vs = 5.0 * (sin(2*3.14*t_now*10)) + 5.0;
        pout_v.write(vs);
    }
};



//! ---------------------------------------------------------------------------
//! @brief testbench toplevel module for  DC motor
//! ---------------------------------------------------------------------------
SC_MODULE(sc_top_motor)
{
    sca_tdf_stimuli_motor  *i_stimuli;
    sca_tdf_dcmotor_em     *i_dcmotor;
    
    sca_tdf::sca_signal<double>  sig_v;
    sca_tdf::sca_signal<double>  sig_a;
    sca_tdf::sca_signal<double>  sig_i;

    
    // trace file
    sca_util::sca_trace_file* tf;
    std::string trace_format;
    
    
    // Constructor
    sc_top_motor(sc_core::sc_module_name nm):sc_module(nm)
    {
        // top level instances
        i_stimuli      = new sca_tdf_stimuli_motor("i_stimuli_2");
        i_stimuli->pout_v(sig_v);
        i_stimuli->pin_a(sig_a);
        i_stimuli->pin_i(sig_i);
        

        i_dcmotor  = new sca_tdf_dcmotor_em("i_dcmotor_eln");
        i_dcmotor->pin_v(sig_v);
        i_dcmotor->pout_a(sig_a);
        i_dcmotor->pout_i(sig_i);
        
        // trace file
        trace_format = "csv";
        tf = trace_format.compare("vcd") == 0 ?
        sca_util::sca_create_vcd_trace_file("tracefile_dcmotor_tb"):
        sca_util::sca_create_tabular_trace_file("tracefile_dcmotor_tb");
        
        sca_util::sca_trace(tf, sig_v, "sig_v");
        sca_util::sca_trace(tf, sig_i, "sig_i");
        sca_util::sca_trace(tf, sig_a, "sig_a");
    };
    
    
    // Destructor
    ~sc_top_motor()
    {
        if(trace_format.compare("vcd"))
            sca_close_tabular_trace_file(tf);
        else
            sca_close_vcd_trace_file(tf);
    }
};








#endif 
